---
title: Vue3ä½¿ç”¨hookå°è£…å¸¸è§çš„å‡ ç§å¼‚æ­¥è¯·æ±‚å‡½æ•°åœºæ™¯ï¼Œè®©å¼€å‘æ›´åŠ ä¸æ»‘ğŸš€ğŸš€ğŸš€
isTimeLine: true
date: 2023-07-05
category:
  - å‰ç«¯
tag:
  - JavaScript
  - Vue
---
> æ–‡ç« åŒæ­¥åœ¨å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›ï¼Œæ¬¢è¿å…³æ³¨

ä»Šå¤©ç»§ç»­[ä¸Šæ¬¡çš„å†…å®¹](https://juejin.cn/post/7251523348596441143?share_token=0094c6cd-3e8d-4c14-9409-d955e7462fa5)ï¼Œä½¿ç”¨hookå°è£…å‡ ç§çš„å¼‚æ­¥è¯·æ±‚å‡½æ•°åœºæ™¯ã€‚

### ğŸš€ ç«‹å³è¯·æ±‚å‡½æ•°

æˆ‘ä»¬æœŸæœ›çš„åœºæ™¯æ˜¯ï¼Œ
- åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚å‡½æ•°ï¼Œç„¶åæ ¹æ®åˆå§‹å‚æ•°ï¼Œç«‹å³å‘é€è¯·æ±‚
- è¿”å›è¯·æ±‚ç»“æœï¼Œå¹¶ä¸”è¿”å›è¯·æ±‚å›è°ƒå‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ ¹æ®æ–°çš„å‚æ•°å†æ¬¡è°ƒç”¨
- è¦æ±‚è¿”å›å€¼åŒ…å«åŠ è½½ä¸­çŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ä»¥åŠæ­£å¸¸çš„æ•°æ®ç±»å‹ã€‚

æˆ‘çš„å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š

å®šä¹‰å…·ä½“çš„æ•°æ®è¿”å›å€¼ç­¾å
```ts
interface Fetch<T> {
  loading: boolean,
  value?: T, // å…·ä½“çš„è¿”å›ç±»å‹æ˜¯æ³›å‹
  error?: string
}
```
å®Œæ•´çš„ç­¾åå¦‚ä¸‹
```ts
export declare function useFetch <T, Params>(
  fn: (args: Params) => Promise<T>,
  initParams: Params  
): [Fetch<T>, (params: Params) => Promise<unknown>]
```
å‡½æ•°å®ç°å¦‚ä¸‹ï¼š
```js
export const useFetch = <T, Params>(
  fn: (args: Params) => Promise<T>,
  initParams: Params  
): [Fetch<T>, (params: Params) => Promise<T>] => {
  
  // å®šä¹‰åŸºç¡€çš„æ•°æ®æ ¼å¼
  const data = reactive<Fetch<T>>({
    loading: true,
    value: undefined,
    error: undefined
  }) as Fetch<T> // è¿™é‡Œä¼šæŠ¥é”™ï¼šTç±»å‹æ— æ³•èµ‹å€¼ç»™UnwrapRef<T>ç±»å‹
  // æˆ‘ä¸æ‡‚ä¸ºå•¥ï¼ŒUnwrapRefæ˜¯vueçš„æ·±å±‚å“åº”å¼ç±»å‹çš„å£°æ˜
  // è¿™é‡Œå¯¼è‡´æˆ‘æ— æ³•é»˜è®¤çš„ç±»å‹èµ‹å€¼ï¼Œä¸ç¬¦åˆç›´è§‰ï¼Œå¯èƒ½æ˜¯æˆ‘tså¤ªèœäº†
  // æ‡‚çš„å¤§ä½¬è¯„è®ºåŒºå¸¦å¸¦æˆ‘å§
  
  // å®šä¹‰è¯·æ±‚å›è°ƒ
  const callback = (params: Params): Promise<T> => new Promise((resolve, reject) => {
    data.loading = true
    fn(params)
      .then(result => {
        data.value = result as any
        resolve(result)
      })
      .catch(error => {
        data.error = error
        reject(error)
      })
      .finally(() => data.loading = false)
  })

  // ç«‹å³æ‰§è¡Œ
  watchSyncEffect(() => {
    callback(initParams)
  })

  return [data, callback]
}
```
æˆ‘ä»¬éªŒè¯ä¸‹
```html
<script setup lang="ts">
import { reactive } from 'vue';
import { useFetch } from './hooks/index';

const fn = () => new Promise((resolve) => {
  setTimeout(()=> resolve({data: [], msg: '', code: 200}), 1000)
})

const [data, fetch] = useFetch<unknown, object>(fn, {})

</script>

<template>
  <h4>å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›</h4>

  <!-- åŠ è½½ä¸­æ—¶ç”¨cssç¦ç”¨æŒ‰é’® -->
  <button
    :style="{'pointer-events': data.loading ? 'none' : 'auto'}"
    @click="fetch({})"
  >{{ data.loading ? 'laoding...' : 'fetch' }}</button>
  
  <h1 v-if="data.loading">loading...</h1>
  <h1 v-else>{{data.value}}</h1>
</template>
```

![fetch.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/061a1d5af7f84c6899fab5d331627bd7~tplv-k3u1fbpfcp-watermark.image?)

é¡µé¢åˆ·æ–°åç«‹å³å‘å‡ºè¯·æ±‚äº†!

### ğŸš€ æ‰‹åŠ¨è¯·æ±‚å‡½æ•°
æˆ‘ä»¬æœŸæœ›çš„åœºæ™¯æ˜¯ï¼Œ
- åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚å‡½æ•°
- è¿”å›è¯·æ±‚å›è°ƒå‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨
- è¦æ±‚è¿”å›å€¼åŒ…å«åŠ è½½ä¸­çŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ä»¥åŠæ­£å¸¸çš„æ•°æ®ç±»å‹

è¿™ä¸ªçš„å®ç°å’Œä¸Šé¢ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¸éœ€è¦åˆå§‹å‚æ•°å’Œç±»å‹ï¼Œä¹Ÿä¸ç”¨ç«‹å³æ‰§è¡Œï¼Œ

å®Œæ•´çš„ç­¾åå¦‚ä¸‹

```ts
export declare function useFetch <T>(
  fn: (args: unknown) => Promise<T>
): [Fetch<T>, (params: unknown) => Promise<T>]
```
å®ç°å¦‚ä¸‹ï¼š

```js
export const useFetchFn = <T>(
  fn: (args: unknown) => Promise<T>
): [Fetch<T>, (params: unknown) => Promise<T>] => {
  
  const data = reactive<Fetch<T>>({
    loading: false, // é»˜è®¤ä¸ºfalse
    value: undefined,
    error: undefined
  }) as Fetch<T>

  const callback = (params: unknown): Promise<T> => new Promise((resolve, reject) => {
    data.loading = true
    fn(params)
      .then(result => {
        data.value = result as any
        resolve(result)
      })
      .catch(error => {
        data.error = error
        reject(error)
      })
      .finally(() => data.loading = false)
  })

  return [data, callback]
}
```
éªŒè¯å¦‚ä¸‹ï¼š
```html
<script setup lang="ts">
import { reactive } from 'vue';
import { useFetchFn } from './hooks/index';

const fn = () => new Promise((resolve) => {
  setTimeout(()=> resolve({data: [], msg: '', code: 200}), 1000)
})

const [data, fetch] = useFetchFn<unknown>(fn)

</script>

<template>
  <h4>å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›</h4>

  <!-- åŠ è½½ä¸­æ—¶ç”¨cssç¦ç”¨æŒ‰é’® -->
  <button
    :style="{'pointer-events': data.loading ? 'none' : 'auto'}"
    @click="fetch({})"
  >{{ data.loading ? 'laoding...' : 'fetch' }}</button>
  
  <h1 v-if="data.loading">loading...</h1>
  <h1 v-else>{{data.value}}</h1>
</template>
```
![fetchfn.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc352f68f5da449b9ec1ef695475860b~tplv-k3u1fbpfcp-watermark.image?)

é¡µé¢åˆ·æ–°åæ²¡æœ‰å‘å‡ºè¯·æ±‚ï¼Œç‚¹å‡»æŒ‰é’®ä¹‹åæ‰å‘å‡ºè¯·æ±‚!

### ğŸš€ è‡ªåŠ¨è¯·æ±‚å‡½æ•°
æˆ‘ä»¬æœŸæœ›çš„åœºæ™¯æ˜¯ï¼Œ
- åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚å‡½æ•°ï¼Œç„¶åæ ¹æ®åˆå§‹å‚æ•°ï¼Œç«‹å³å‘é€è¯·æ±‚
- å½“å‚æ•°å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ ¹æ®æœ€æ–°å‚æ•°å‘ç”Ÿè¯·æ±‚
- è¦æ±‚è¿”å›å€¼åŒ…å«åŠ è½½ä¸­çŠ¶æ€ï¼Œé”™è¯¯ä¿¡æ¯ä»¥åŠæ­£å¸¸çš„æ•°æ®ç±»å‹ã€‚

è¿™ä¸ªçš„å®ç°å’Œç«‹å³è¯·æ±‚å‡½æ•°ç±»ä¼¼ï¼Œåªéœ€è¦ç›‘å¬å‚æ•°çš„å˜åŒ–ï¼Œ

å®Œæ•´çš„ç­¾åå¦‚ä¸‹
```ts
export declare function useFetch <T, Params>(
  fn: (args: Params) => Promise<T>,
  initParams: Params  
): Fetch<T>
```
å®ç°å¦‚ä¸‹ï¼š
```js
export const useAutoFetch = <T, Params>(
  fn: (args: Params) => Promise<T>,
  initParams: Params  
): Fetch<T> => {
  
  const data = reactive<Fetch<T>>({
    loading: true,
    value: undefined,
    error: undefined
  }) as Fetch<T>

  const callback = (params: Params): Promise<T> => new Promise((resolve, reject) => {
    data.loading = true
    fn(params)
      .then(result => {
        data.value = result as any
        resolve(result)
      })
      .catch(error => {
        data.error = error
        reject(error)
      })
      .finally(() => data.loading = false)
  })

  // å¦‚æœä¸éœ€è¦ç«‹å³æ‰§è¡Œï¼Œå¯æ²¡æœ‰è¿™æ­¥
  const effects = watchSyncEffect(() => {
    callback(initParams)
  })

  // è‡ªåŠ¨ç›‘å¬å‚æ•°å˜åŒ–
  const effects = watch([initParams], () => callback(initParams))
  // å¸è½½é¡µé¢æ—¶ï¼Œå…³é—­ç›‘å¬
  onUnmounted(() => effects())

  return data
}
```

æˆ‘ä»¬éªŒè¯ä¸‹åŠŸèƒ½

```html
<script setup lang="ts">
import { reactive, watch } from 'vue';
import { useAutoFetch } from './hooks/index';

const fn = () => new Promise((resolve) => {
  setTimeout(()=> resolve({data: [], msg: '', code: 200}), 1000)
})

const params = reactive({
  age: 9
})

const data = useAutoFetch<unknown, object>(fn, params)

watch(params, () => console.log(params))

</script>

<template>
  <h4>å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›</h4>
  
  <div>{{ params.age }}</div>
  <!-- åŠ è½½ä¸­æ—¶ç”¨cssç¦ç”¨æŒ‰é’® -->
  <button
    :style="{'pointer-events': data.loading ? 'none' : 'auto'}"
    @click="() => params.age++"
  >{{ data.loading ? 'laoding...' : 'change params' }}</button>
  
  <h1 v-if="data.loading">loading...</h1>
  <h1 v-else>{{data.value}}</h1>
</template>
```

![auto.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d14d9da78ca47428c572132eeecc2c6~tplv-k3u1fbpfcp-watermark.image?)

æ¯æ¬¡å½“æˆ‘ä»¬æ”¹å˜å‚æ•°æ—¶è‡ªåŠ¨å‘é€è¯·æ±‚ã€‚

ä»Šå¤©çš„åˆ†äº«å°±è¿™äº›ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ä¸è¶³çš„åœ°æ–¹ï¼Œååˆ†æ„Ÿè°¢