---
title: ğŸš€ğŸš€vue3è‡ªå®šä¹‰æŒ‡ä»¤å®è·µ
isTimeLine: true
date: 2023-07-03
category:
  - å‰ç«¯
tag:
  - JavaScript
  - Vue
---
> æ–‡ç« é¦–å‘å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›ï¼Œæ¬¢è¿å…³æ³¨
### ğŸš€ å…³é”®æ¥å£ä»‹ç»

æœ€è¿‘æƒ³ä½“éªŒä¸‹è‡ªå®šä¹‰æŒ‡ä»¤åŠŸèƒ½ï¼Œçœ‹äº†çœ‹æ–‡æ¡£å’Œ vue2 å·®å¼‚ä¸å¤§ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š
```js
const myDirective = {
// åœ¨ç»‘å®šå…ƒç´ çš„ attribute å‰ 
// æˆ–äº‹ä»¶ç›‘å¬å™¨åº”ç”¨å‰è°ƒç”¨
created(el, binding, vnode, prevVnode) 
{ // ä¸‹é¢ä¼šä»‹ç»å„ä¸ªå‚æ•°çš„ç»†èŠ‚ }, 
// åœ¨å…ƒç´ è¢«æ’å…¥åˆ° DOM å‰è°ƒç”¨
beforeMount(el, binding, vnode, prevVnode) {},
// åœ¨ç»‘å®šå…ƒç´ çš„çˆ¶ç»„ä»¶
// åŠä»–è‡ªå·±çš„æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æŒ‚è½½å®Œæˆåè°ƒç”¨
mounted(el, binding, vnode, prevVnode) {},
// ç»‘å®šå…ƒç´ çš„çˆ¶ç»„ä»¶æ›´æ–°å‰è°ƒç”¨
beforeUpdate(el, binding, vnode, prevVnode) {},
// åœ¨ç»‘å®šå…ƒç´ çš„çˆ¶ç»„ä»¶
// åŠä»–è‡ªå·±çš„æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æ›´æ–°åè°ƒç”¨
updated(el, binding, vnode, prevVnode) {},
// ç»‘å®šå…ƒç´ çš„çˆ¶ç»„ä»¶å¸è½½å‰è°ƒç”¨
beforeUnmount(el, binding, vnode, prevVnode) {},
// ç»‘å®šå…ƒç´ çš„çˆ¶ç»„ä»¶å¸è½½åè°ƒç”¨
unmounted(el, binding, vnode, prevVnode) {} }
```
èµ·åˆï¼Œæœ€å¤§çš„ç—›ç‚¹æ˜¯éœ€è¦æ‰‹åŠ¨åˆ›å»º dom ï¼Œç„¶åæ’å…¥ el ä¸­ã€‚
```js
const loadingDom = document.createElement('div', {calss: 'loading'})
el.append(loadingDom)
```
è¿™æ ·å¥½éš¾å—å•Šï¼Œæˆ‘ä¸æƒ³å†™åŸç”Ÿ dom ï¼Œèƒ½ä¸èƒ½å†™ä¸ªç»„ä»¶æ¸²æŸ“åˆ°æŒ‡ä»¤é‡Œå‘¢ï¼Ÿ

æˆ‘æƒ³èµ·äº†æˆ‘ä¹‹å‰çœ‹åˆ°çš„å‡ ä¸ª vue æ¥å£ï¼Œ
- hå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ vue æä¾›çš„åˆ›å»º vNode çš„å‡½æ•°
- renderå‡½æ•°ï¼šå°† vNode æ¸²æŸ“åˆ° çœŸå® dom é‡Œçš„å‡½æ•°

hå‡½æ•°ç”¨æ³•å¦‚ä¸‹ï¼š
```js
// å®Œæ•´å‚æ•°ç­¾å
function h(
    type: string | Component,
    props?: object | null,
    children?: Children | Slot | Slots
): VNode
```
ä¾‹å¦‚ï¼š
```js
import { h } from 'vue'

const vnode = h('div', { class: 'container' }, [
  h('h1', 'Hello, Vue 3'),
  h('p', 'This is a paragraph')
])
```
æˆ‘ä»¬ä½¿ç”¨hå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª VNodeï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªåŒ…å« divã€h1ã€p çš„ DOM ç»“æ„ã€‚å…¶ä¸­ï¼Œdiv çš„ class å±æ€§ä¸º container

### ğŸš€ è‡ªå®šä¹‰ loading ç»„ä»¶

ç„¶è€Œï¼Œå½“æˆ‘ä½¿ç”¨ props ä¸ºç»„ä»¶ä¼ é€’å€¼æ—¶ï¼Œå‘ç°æ˜¯å¾’åŠ³çš„ã€‚

```js
import Loading from './components/Loading.vue';

cconst option = {
    msg: 'ä¸€å¤§æ³¢åƒµå°¸æ¥è¢­',
    loading: true
}

const vnode = h(
    Loading,
    { id: 'loading', ...option}
)
```
ä»…ä»…å¦‚ä¸‹å›¾ä¸€æ ·ï¼Œæˆ‘ä»¥ä¸ºæ˜¯ç»™ç»„ä»¶çš„ propsï¼Œå®é™…ä¸Šæ˜¯ dom çš„ propsã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/267b68e314a24280b84290fc80059ba7~tplv-k3u1fbpfcp-watermark.image?)

æ­¤æ—¶æˆ‘ä»¬çš„ç»„ä»¶åªèƒ½é€šè¿‡ `$attrs` æ¥è·å–è¿™äº› props äº†ï¼Œå¦‚ä¸‹ï¼š

```js
<template>

  <div class="loading">
    <div></div>
    <span v-if="$attrs.msg !== false">{{ $attrs.msg }}</span>
  </div>
  
</template>
```
æ¥ç€æˆ‘ä»¬ç»™ç»„ä»¶å®ç° loading åŠ¨ç”»ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ç»„ä»¶åº“çš„ loading ç»„ä»¶ã€‚

æˆ‘çš„å®ç°å¦‚ä¸‹ï¼š

```js
<style>
  @keyframes identifier {
    100% {
      -webkit-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  .loading {
    height: 100px;
    width: 100%;
  }
  .loading div {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid green;
    margin: 25px auto;
    border-top: none;
    border-left: none;
    animation: identifier 1s infinite linear;
  }
</style>
```
### ğŸš€ è‡ªå®šä¹‰æŒ‡ä»¤

æ¥ä¸‹æ¥æˆ‘ä»¬å°è£…è‡ªå®šä¹‰æŒ‡ä»¤ã€‚

æˆ‘ä»¬çš„æ€è·¯æ˜¯ï¼š
- mounted é˜¶æ®µï¼Œå¦‚æœæ˜¯ trueï¼Œé‚£ä¹ˆæ¸²æŸ“ç»„ä»¶ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚
- update é˜¶æ®µï¼Œå¦‚æœ true åˆ™é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œå¦‚æœ false åˆ™æ¸²æŸ“ vnode

ä¸ºäº†å¯ä»¥åº”å¯¹æ›´å¤šåœºæ™¯ï¼Œæˆ‘ä»¬æœŸæœ›å¯ä»¥é…ç½®åŠ è½½ä¸­çš„æç¤ºä¿¡æ¯ï¼Œä¸é…ç½®ä½¿ç”¨é»˜è®¤å€¼ï¼Œå¦‚æœæ˜¯ false ï¼Œé‚£ä¹ˆä»…å±•ç¤º loading å›¾ã€‚æ‰€ä»¥å‚æ•°ç±»å‹å¦‚ä¸‹ï¼š

```js
interface Props  {loading: boolean, msg?: string | false}

v-loading: boolean | Props
```
ç”±äºå¯èƒ½æ˜¯å¸ƒå°”å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–é…ç½®å‚æ•°
```js
function formatOption (value: boolean | Props) {
  const loading = typeof value === 'boolean'
      ? value 
      : value.loading
  const option = typeof value !== 'boolean'
    ? Object.assign(defaultOption, value)
    : {
      loading,
      ...defaultOption
    }
  return { loading, option }
}
```
æ¥ç€å† mounted é˜¶æ®µè·å–æ ¼å¼åŒ–åçš„ loading å’Œ optionï¼Œå¦‚æœä¸º true åˆ™ç›´æ¥æ¸²æŸ“ç»„ä»¶ã€‚
```js
const vLoading: Directive<HTMLElement, boolean | Props> = {
  mounted(el, binding) {

    const { loading, option } = formatOption(binding.value)

    loading && renderLoading(el, option)

  }
}

function renderLoading (el: HTMLElement, option: Props) {
  const vnode = h(
    Loading,
    { id: 'loading', ...option}
  )
  el.removeChild(el.children[0])
  render(vnode, el)
}
```
å¦‚æœè¿›å…¥ update é˜¶æ®µï¼Œåˆ™æ ¹æ®æƒ…å†µé€‰æ‹©æ¸²æŸ“ laoding ç»„ä»¶è¿˜æ˜¯ vnodeã€‚

```js
const vLoading: Directive<HTMLElement, boolean | Props> = {
  mounted(el, binding) {

    const { loading, option } = formatOption(binding.value)

    loading && renderLoading(el, option)

  },
  updated(el: HTMLElement, binding, vnode) {

    const { loading, option } = formatOption(binding.value)

    if (loading) {
      renderLoading(el, option)
    } else {
      renderVNode(el, vnode)
    }

  },
}

function renderLoading (el: HTMLElement, option: Props) {
  const vnode = h(
    Loading,
    { id: 'loading', ...option}
  )
  el.removeChild(el.children[0])
  render(vnode, el)
}

function renderVNode (el: HTMLElement, vnode: VNode) {
  el.querySelector('#loading')?.remove()
  render(vnode, el)
}
```
æˆ‘ä»¬éªŒè¯ä¸‹åŠŸèƒ½ï¼š

- é»˜è®¤åŠŸèƒ½
```js
const loading = ref(true)

setTimeout(() => loading.value = false, 2000)

</script>

<template>
  <div style="width: 300px" v-loading=laoding>
    <h1>åŠ è½½æˆåŠŸ</h1>
  </div>
</template>
```

![laoding1.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/244ea2bc975d404fab0e3ec848ea5e6b~tplv-k3u1fbpfcp-watermark.image?)
- è‡ªå®šä¹‰æ–‡æœ¬
```js
<template>
  <div style="width: 300px" v-loading="{ loading, msg: 'ä¸€å¤§æ³¢åƒµå°¸æ¥è¢­' }">
    <h1>åŠ è½½æˆåŠŸ</h1>
  </div>
</template>
```
![laoding2.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a95db550a7a43ba886b18594d1b7495~tplv-k3u1fbpfcp-watermark.image?)

- ä¸å±•ç¤ºæ–‡æœ¬
```js
<template>
  <div style="width: 300px" v-loading="{ loading, msg: false }">
    <h1>åŠ è½½æˆåŠŸ</h1>
  </div>
</template>
```
![laoding3.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac5b8327e1514395ad386cc12c9f7179~tplv-k3u1fbpfcp-watermark.image?)

### ğŸ‰ æœ€å

ä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™äº†ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šåŠæ—¶æ›´æ­£ã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä»£ç ã€‚
```js
<template>

  <div class="loading">
    <div></div>
    <span v-if="$attrs.msg !== false">{{ $attrs.msg }}</span>
  </div>
  
</template>
  
<script lang="ts">
export default {  
}
</script>
  
<style>
  @keyframes identifier {
    100% {
      -webkit-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  .loading {
    height: 100px;
    width: 100%;
  }
  .loading div {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid green;
    margin: 25px auto;
    border-top: none;
    border-left: none;
    animation: identifier 1s infinite linear;
  }
</style>
```

```js
<script setup lang="ts">
import { Directive, VNode, h, ref, render  } from 'vue';
import Loading from './components/Loading.vue';

const defaultOption: {msg?: string | false} = {
  msg: 'åŠªåŠ›åŠ è½½ä¸­'
}

interface Props  {loading: boolean, msg?: string | false}

function formatOption (value: boolean | Props) {
  const loading = typeof value === 'boolean'
      ? value 
      : value.loading
  const option = typeof value !== 'boolean'
    ? Object.assign(defaultOption, value)
    : {
      loading,
      ...defaultOption
    }
  return { loading, option }
}

function renderLoading (el: HTMLElement, option: Props) {
  const vnode = h(
    Loading,
    { id: 'loading', ...option}
  )
  el.removeChild(el.children[0])
  render(vnode, el)
}

function renderVNode (el: HTMLElement, vnode: VNode) {
  el.querySelector('#loading')?.remove()
  render(vnode, el)
}

const vLoading: Directive<HTMLElement, boolean | Props> = {
  mounted(el, binding) {

    const { loading, option } = formatOption(binding.value)

    loading && renderLoading(el, option)

  },
  updated(el: HTMLElement, binding, vnode) {

    const { loading, option } = formatOption(binding.value)

    if (loading) {
      renderLoading(el, option)
    } else {
      renderVNode(el, vnode)
    }

  },
}

const loading = ref(true)

setTimeout(() => loading.value = false, 2000)

</script>

<template>
  <div style="width: 300px" v-loading="{ loading, msg: 'ä¸€å¤§æ³¢åƒµå°¸æ¥è¢­' }">
    <h1>åŠ è½½æˆåŠŸ</h1>
  </div>
</template>

```
